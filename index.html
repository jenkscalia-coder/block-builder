<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Advanced Planner v2.2.1 â€” FAB Add Room</title>
<style>
:root{--bg:#0b0f15;--panel:#10161f;--ink:#e6edf3;--muted:#9fb0c2;--grid:#1d2533;--btn:#141c28;--btn-b:#25344a;--accent:#58a6ff;--danger:#ff6b6b}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial}
*{box-sizing:border-box}
.app{height:100%;display:grid;grid-template-rows:auto 1fr}
.toolbar{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#0e141d;border-bottom:1px solid #1b2230}
.title{font-weight:600;letter-spacing:.2px}
.spacer{flex:1}
.btn,.field{appearance:none;background:var(--btn);border:1px solid var(--btn-b);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer;font:inherit}
.btn:active{transform:translateY(1px)}
.field{cursor:text}
.hint{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:6px;margin-left:8px;flex-wrap:wrap}
.tab{padding:6px 10px;border-radius:10px;border:1px solid var(--btn-b);background:var(--btn);cursor:pointer}
.tab[data-active="1"]{background:#1d2736;border-color:#3b4a62;box-shadow:inset 0 6px 16px rgba(0,0,0,.35)}
.stageWrap{position:relative;overflow:hidden}
.stage{position:absolute;inset:0;cursor:grab;user-select:none;touch-action:none;background:#0b0f15}
.stage.gridOn{background:
  radial-gradient(ellipse at center, rgba(95,176,255,.08), transparent 60%),
  linear-gradient(var(--grid) 1px, transparent 1px) 0 0/40px 40px,
  linear-gradient(90deg, var(--grid) 1px, transparent 1px) 0 0/40px 40px,
  #0b0f15;}
.stage:active{cursor:grabbing}
.world{position:absolute;left:0;top:0;transform-origin:0 0;will-change:transform;filter:drop-shadow(0 18px 38px rgba(0,0,0,.45))}
.level-layer{position:absolute;inset:0}
.ghost{opacity:.45;filter:grayscale(1) brightness(.9);pointer-events:none}
.isometric .world{transform:perspective(1200px) rotateX(58deg) rotateZ(45deg)!important}
.room{position:absolute;min-width:40px;min-height:40px;border-radius:12px;box-shadow:0 14px 40px rgba(24,34,52,.35), 0 2px 8px rgba(0,0,0,.35);color:#0c1016;font-weight:700;cursor:move;background:#7cc4ff}
.room .label{position:absolute;left:10px;top:8px;right:34px;font-size:12px;color:#0c1016;outline:none}
.room .area{position:absolute;left:10px;bottom:8px;right:10px;font-size:11px;color:#0c1016;opacity:.85;cursor:pointer}
.areaEdit{position:absolute;left:8px;bottom:6px;width:120px;font:12px Inter,system-ui;background:#0f1620;color:#e6edf3;border:1px solid #273245;border-radius:6px;padding:4px 6px}
.handle{position:absolute;width:14px;height:14px;right:-7px;bottom:-7px;background:#0e141d;border:2px solid #e6edf3;border-radius:6px;cursor:nwse-resize}
.sel{outline:2px solid rgba(255,255,255,.75);outline-offset:0}
/* HUD fixed bottom-left */
.hud{position:absolute;left:12px;bottom:12px;pointer-events:none;z-index:60}
.dims{display:inline-block;background:#0f151fcc;border:1px solid #233145;color:#cfe3ff;font:11px/1.2 Inter;padding:6px 8px;border-radius:8px;min-width:220px}
/* Context menus */
.ctx{position:absolute;min-width:210px;background:#0f151f;border:1px solid #223044;border-radius:10px;box-shadow:0 16px 40px rgba(0,0,0,.55);padding:6px;display:none;z-index:80}
.ctx button{width:100%;text-align:left;border:0;background:transparent;color:#dfe9f7;padding:8px 10px;border-radius:8px;cursor:pointer}
.ctx button:hover{background:#172131}
.ctx .sep{height:1px;background:#1e2735;margin:6px 4px}
.ctx .danger:hover{background:#2a1418;color:#ffd4d4}
/* Export dropdown (toolbar) */
.menu{position:absolute;right:0;top:100%;margin-top:6px;background:#0f151f;border:1px solid #223044;border-radius:10px;box-shadow:0 16px 40px rgba(0,0,0,.55);padding:6px;display:none;z-index:90}
.menu button{width:100%;text-align:left;border:0;background:transparent;color:#dfe9f7;padding:8px 10px;border-radius:8px;cursor:pointer}
.menu button:hover{background:#172131}
/* Floating Add (+) */
.fab{position:absolute;right:16px;bottom:16px;width:56px;height:56px;border-radius:16px;background:#1e6bff;border:1px solid #1652f0;color:#fff;font-weight:800;font-size:28px;line-height:0;display:grid;place-items:center;cursor:pointer;box-shadow:0 18px 44px rgba(0,0,0,.45)}
.fab:active{transform:translateY(1px)}
/* Add-room sheet */
.sheet{position:absolute;right:16px;bottom:86px;background:var(--panel);border:1px solid #1b2230;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.55);width:300px;display:none;z-index:95}
.sheet header{padding:10px 12px;border-bottom:1px solid #1b2230;font-weight:600}
.sheet .body{padding:12px;display:grid;gap:10px}
.sheet label{font-size:12px;color:var(--muted)}
.sheet input[type=text],.sheet input[type=number]{width:100%;background:#101722;border:1px solid #1f2836;border-radius:10px;color:#e6edf3;padding:8px 10px;font:inherit}
.swatchRow{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.sw{height:22px;border-radius:6px;border:1px solid #223046;cursor:pointer}
.sw[data-sel="1"]{outline:2px solid var(--accent)}
.sheet .actions{display:flex;gap:8px;margin-top:6px}
</style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="title">Advanced Planner</div>
    <div class="tabs" id="tabs"></div>
    <button id="addLevel" class="btn">+ Floor</button>
    <button id="dupLevel" class="btn">â§‰ Duplicate</button>
    <button id="delLevel" class="btn">â€“ Remove</button>
    <div class="spacer"></div>
    <span class="hint">Wheel=Zoom Â· Space/Right-drag=Pan Â· Alt+Drag=Duplicate Â· Shift+Click=Multi Â· Ctrl=Magnet Snap</span>
    <button id="toggleIso" class="btn">2D</button>
    <label style="display:flex;align-items:center;gap:6px;margin-left:8px">
      <span class="hint">mÂ² / grid</span>
      <input id="m2PerSquare" class="field" type="number" step="0.5" value="4" style="width:80px">
    </label>
    <div class="exportWrap" style="position:relative">
      <button id="exportBtn" class="btn">Export â–¾</button>
      <div id="exportMenu" class="menu">
        <button data-x="png">PNG (current level)</button>
        <button data-x="svg">SVG (current level)</button>
        <button data-x="dxf">DXF (current level)</button>
      </div>
    </div>
  </div>

  <div class="stageWrap" id="wrap">
    <div id="stage" class="stage gridOn" aria-label="planning canvas">
      <div id="hud" class="hud"><div class="dims" id="dimsText">Hover a blockâ€¦</div></div>
      <div id="world" class="world"></div>
      <button id="fab" class="fab" title="Add Room" aria-label="Add Room">+</button>
    </div>

    <!-- Add Room Sheet -->
    <div id="sheet" class="sheet" role="dialog" aria-modal="true" style="display:none">
      <header>Add Room</header>
      <div class="body">
        <div><label>Name</label><input id="nameIn" type="text" placeholder="e.g. Childcare 1"/></div>
        <div><label>Size (mÂ²)</label><input id="areaIn" type="number" min="1" step="1" value="60"/></div>
        <div><label>Colour</label><div class="swatchRow" id="swatches"></div></div>
        <div class="actions"><button id="addBtn" class="btn" style="background:#1e6bff;border-color:#1652f0">Add</button><button id="cancelBtn" class="btn">Cancel</button></div>
      </div>
    </div>

    <!-- Canvas context menu -->
    <div id="canvasCtx" class="ctx" role="menu">
      <button data-act="grid">ðŸ”² Toggle Grid</button>
      <div class="sep"></div>
      <button data-act="exp-png">ðŸ“¤ Export PNG</button>
      <button data-act="exp-svg">ðŸ“¤ Export SVG</button>
      <button data-act="exp-dxf">ðŸ“¤ Export DXF</button>
      <div class="sep"></div>
      <button data-act="dup">â§‰ Duplicate Selection</button>
      <button data-act="del" class="danger">ðŸ—‘ Delete Selection</button>
    </div>

    <!-- Block (room) context menu -->
    <div id="blockCtx" class="ctx" role="menu">
      <button data-act="dup">ðŸŸ© Duplicate</button>
      <button data-act="color">ðŸŽ¨ Change Color</button>
      <div class="sep"></div>
      <button data-act="del" class="danger">ðŸ—‘ Delete</button>
    </div>

  </div>
</div>

<script>
/* ===== Core state ===== */
const stage=document.getElementById('stage'),wrap=document.getElementById('wrap'),world=document.getElementById('world');
const dimsText=document.getElementById('dimsText');
let scale=1,offset={x:200,y:120},panning=false,spacePan=false,panStart={x:0,y:0},offsetStart={x:0,y:0};
const GRID=40,COLORS=['#a8e6a3','#7cc4ff','#ff9fb6','#ffd37e','#d2c2ff','#c8d3e3','#b8f7bf','#bdbfc4','#f39c9c','#f7c07a','#9ad8c6','#cba6f7','#9fc0ff','#8bd2b0'];
let gridEnabled=true;let ctrlSnap=false;
function applyTransform(){world.style.transform=`translate(${offset.x}px,${offset.y}px) scale(${scale})`}applyTransform();
function screenToWorld(sx,sy){const r=stage.getBoundingClientRect();return{ x:(sx-r.left-offset.x)/scale, y:(sy-r.top-offset.y)/scale }}
function suspendIsoIfAny(){const was=wrap.classList.contains('isometric');if(was)wrap.classList.remove('isometric');return was}
function resumeIsoIfNeeded(was){if(was)wrap.classList.add('isometric')}

/* ===== Dynamic floors ===== */
let levels=[];let ghosts=[];let currentLevel=0;
const tabs=document.getElementById('tabs');
function makeLevel(idx){const layer=document.createElement('div');layer.className='level-layer';layer.id='level'+idx;const ghost=document.createElement('div');ghost.className='level-layer ghost';ghost.id='ghost'+idx;ghost.style.display='none';world.appendChild(layer);world.appendChild(ghost);return {layer,ghost};}
function refreshTabs(){tabs.innerHTML='';levels.forEach((L,i)=>{const b=document.createElement('button');b.className='tab';b.dataset.level=i;b.textContent=(i===0?'Ground':`Level ${i}`);b.dataset.active=(i===currentLevel?'1':'0');b.addEventListener('click',()=>setLevel(i));tabs.appendChild(b)})}
function setLevel(i){currentLevel=i;levels.forEach((L,idx)=>{L.layer.style.display=idx===i?'block':'none'});ghosts.forEach(g=>g.style.display='none');if(i>0){const g=ghosts[i],prev=levels[i-1].layer;g.innerHTML='';prev.querySelectorAll('.room').forEach(src=>{const gh=src.cloneNode(true);gh.classList.remove('sel');gh.style.pointerEvents='none';g.appendChild(gh)});g.style.display='block'}refreshTabs()}
function addLevel(){const i=levels.length;const pair=makeLevel(i);levels.push(pair);ghosts.push(pair.ghost);if(i===0)pair.layer.style.display='block';else pair.layer.style.display='none';refreshTabs();return i}
function duplicateLevel(i){const idx=levels.length;const pair=makeLevel(idx);levels.push(pair);ghosts.push(pair.ghost);levels[i].layer.querySelectorAll('.room').forEach(n=>{const c=n.cloneNode(true);pair.layer.appendChild(c);attachRoom(c)});setLevel(idx)}
function removeLevel(i){if(levels.length<=1){alert('Cannot remove the last floor.');return}world.removeChild(levels[i].layer);world.removeChild(ghosts[i]);levels.splice(i,1);ghosts.splice(i,1);setLevel(Math.max(0,i-1));refreshTabs()}
addLevel();

/* ===== Zoom & Pan ===== */
stage.addEventListener('wheel',e=>{e.preventDefault();const m=screenToWorld(e.clientX,e.clientY),f=Math.exp(-e.deltaY*.0015),ns=Math.min(4,Math.max(.25,scale*f)),rect=stage.getBoundingClientRect();offset.x=e.clientX-rect.left-m.x*ns;offset.y=e.clientY-rect.top-m.y*ns;scale=ns;applyTransform()},{passive:false});
stage.addEventListener('contextmenu',e=>e.preventDefault());
stage.addEventListener('pointerdown',e=>{if(e.button===2||spacePan){panning=true;panStart={x:e.clientX,y:e.clientY};offsetStart={...offset};stage.setPointerCapture(e.pointerId)}});
stage.addEventListener('pointermove',e=>{if(!panning)return;const dx=e.clientX-panStart.x,dy=e.clientY-panStart.y;offset.x=offsetStart.x+dx;offset.y=offsetStart.y+dy;applyTransform()});
stage.addEventListener('pointerup',()=>panning=false);
window.addEventListener('keydown',e=>{if(e.code==='Space'){spacePan=true;document.body.style.cursor='grabbing'} if(e.ctrlKey){ctrlSnap=true}});
window.addEventListener('keyup',e=>{if(e.code==='Space'){spacePan=false;document.body.style.cursor='auto'} if(!e.ctrlKey){ctrlSnap=false}});

/* ===== Rooms & geometry ===== */
function m2FromSize(pxW,pxH){const m2ps=parseFloat(document.getElementById('m2PerSquare').value)||4;const metersPerGrid=Math.sqrt(m2ps);const width_m=(pxW/GRID)*metersPerGrid, height_m=(pxH/GRID)*metersPerGrid;return {width_m,height_m,area_m2:width_m*height_m}}
function updateAreaLabel(el){const a=el.querySelector('.area');const {area_m2}=m2FromSize(el.clientWidth,el.clientHeight);a.textContent=`${area_m2.toFixed(0)} mÂ²`}
function updateHud(el){const {width_m,height_m,area_m2}=m2FromSize(el.clientWidth,el.clientHeight);dimsText.textContent=`${width_m.toFixed(2)}m Ã— ${height_m.toFixed(2)}m Â· ${area_m2.toFixed(0)} mÂ²`}
function createRoomEl(name,color,x,y,w,h,areaText){const el=document.createElement('div');el.className='room';el.style.left=x+'px';el.style.top=y+'px';el.style.width=(w||120)+'px';el.style.height=(h||90)+'px';el.style.background=color;const label=document.createElement('div');label.className='label';label.textContent=name||'Room';label.contentEditable=true;const area=document.createElement('div');area.className='area';area.textContent=areaText||'60 mÂ²';area.title='Click to edit area (mÂ²)';const handle=document.createElement('div');handle.className='handle';el.append(label,area,handle);return el}
function createRoom({name='Room',m2=60,color=COLORS[1],x=0,y=0}={}){const m2ps=parseFloat(document.getElementById('m2PerSquare').value)||4, metersPerGrid=Math.sqrt(m2ps);const targetWidth_m=Math.sqrt(m2), targetHeight_m=Math.max(1,targetWidth_m*0.7);const pxW=Math.max(40,targetWidth_m/metersPerGrid*GRID), pxH=Math.max(40,targetHeight_m/metersPerGrid*GRID);const el=createRoomEl(name,color,x,y,pxW,pxH,`${m2.toFixed(0)} mÂ²`);levels[currentLevel].layer.appendChild(el);attachRoom(el);return el}

/* Selection */
let selection=new Set();function clearSel(){selection.forEach(n=>n.classList.remove('sel'));selection.clear()}
function toggleSel(el,multi){if(!multi)clearSel();if(selection.has(el)){el.classList.remove('sel');selection.delete(el)}else{el.classList.add('sel');selection.add(el)}}
function getCurrentRooms(){return[...levels[currentLevel].layer.querySelectorAll('.room')]}

/* Ctrl magnet-snap */
function applyCtrlSnap(primary){if(!ctrlSnap) return;const tol=10, others=getCurrentRooms().filter(n=>!selection.has(n)); if(!others.length) return;const lx=parseFloat(primary.style.left), ty=parseFloat(primary.style.top), rx=lx+primary.clientWidth, by=ty+primary.clientHeight, cx=lx+primary.clientWidth/2, cy=ty+primary.clientHeight/2;let offX=0, offY=0;for(const o of others){const ol=parseFloat(o.style.left), ot=parseFloat(o.style.top), orr=ol+o.clientWidth, ob=ot+o.clientHeight, ocx=ol+o.clientWidth/2, ocy=ot+o.clientHeight/2;if(Math.abs(ty-ot)<tol) offY=ot-ty; if(Math.abs(by-ob)<tol) offY=ob-by; if(Math.abs(cy-ocy)<tol) offY=ocy-cy;if(Math.abs(lx-ol)<tol) offX=ol-lx; if(Math.abs(rx-orr)<tol) offX=orr-rx; if(Math.abs(cx-ocx)<tol) offX=ocx-cx}if(offX||offY){selection.forEach(n=>{n.style.left=(parseFloat(n.style.left)+offX)+'px';n.style.top=(parseFloat(n.style.top)+offY)+'px'})}}

/* Attach interactions to a room */
function attachRoom(el){
  el.addEventListener('pointerenter',()=>updateHud(el));
  el.addEventListener('pointerleave',()=>{dimsText.textContent='Hover a blockâ€¦'});
  el.addEventListener('pointerdown',e=>{if(e.button===2||spacePan)return;if(e.target.classList.contains('handle'))return;e.stopPropagation();toggleSel(el,e.shiftKey)});
  // Drag
  let dragging=false,startScreen={x:0,y:0},startPos=new Map(),isoWas=false;
  el.addEventListener('pointerdown',e=>{
    if(e.button!==0||spacePan)return;if(e.target.classList.contains('handle'))return;e.stopPropagation();
    if(!selection.has(el)){clearSel();selection.add(el);el.classList.add('sel')}
    if(e.altKey){const ns=new Set();selection.forEach(n=>{const c=n.cloneNode(true);levels[currentLevel].layer.appendChild(c);attachRoom(c);c.style.left=(parseFloat(n.style.left)+GRID)+'px';c.style.top=(parseFloat(n.style.top)+GRID)+'px';ns.add(c)});clearSel();ns.forEach(n=>{n.classList.add('sel');selection.add(n)})}
    isoWas=suspendIsoIfAny();dragging=true;startScreen={x:e.clientX,y:e.clientY};startPos.clear();selection.forEach(n=>startPos.set(n,{l:parseFloat(n.style.left),t:parseFloat(n.style.top)}));el.setPointerCapture(e.pointerId);
  });
  el.addEventListener('pointermove',e=>{if(!dragging)return;const dx=(e.clientX-startScreen.x)/scale, dy=(e.clientY-startScreen.y)/scale;selection.forEach(n=>{const s=startPos.get(n);n.style.left=(s.l+dx)+'px';n.style.top=(s.t+dy)+'px'});applyCtrlSnap(el);updateHud(el)});
  el.addEventListener('pointerup',()=>{if(!dragging)return;dragging=false;updateHud(el);resumeIsoIfNeeded(isoWas)});
  // Resize
  const h=el.querySelector('.handle');let resizing=false,startSize={w:0,h:0},startRS={x:0,y:0},isoWasRS=false;
  h.addEventListener('pointerdown',e=>{resizing=true;e.stopPropagation();isoWasRS=suspendIsoIfAny();startRS={x:e.clientX,y:e.clientY};startSize={w:el.clientWidth,h:el.clientHeight};h.setPointerCapture(e.pointerId)});
  h.addEventListener('pointermove',e=>{if(!resizing)return;const dx=(e.clientX-startRS.x)/scale,dy=(e.clientY-startRS.y)/scale;el.style.width=Math.max(40,startSize.w+dx)+'px';el.style.height=Math.max(40,startSize.h+dy)+'px';updateAreaLabel(el);updateHud(el)});
  h.addEventListener('pointerup',()=>{if(!resizing)return;resizing=false;updateAreaLabel(el);updateHud(el);resumeIsoIfNeeded(isoWasRS)});
  // Area edit
  const area=el.querySelector('.area');area.addEventListener('click',()=>{if(el.querySelector('.areaEdit'))return;const box=document.createElement('input');box.className='areaEdit';box.type='number';box.step='1';box.min='1';const cur=parseFloat(area.textContent)||60;box.value=cur;el.appendChild(box);box.focus();box.select();
    const commit=()=>{const nm=Math.max(1,parseFloat(box.value)||cur),m2ps=parseFloat(document.getElementById('m2PerSquare').value)||4,metersPerGrid=Math.sqrt(m2ps),asp=el.clientWidth/Math.max(1,el.clientHeight);
      const targetWidth_m=Math.sqrt(nm*asp),targetHeight_m=Math.max(0.5,nm/targetWidth_m);const W=Math.max(40,targetWidth_m/metersPerGrid*GRID),H=Math.max(40,targetHeight_m/metersPerGrid*GRID);
      el.style.width=W+'px';el.style.height=H+'px';area.textContent=`${nm.toFixed(0)} mÂ²`;box.remove();updateHud(el)};
    box.addEventListener('keydown',e=>{if(e.key==='Enter')commit();if(e.key==='Escape')box.remove()});box.addEventListener('blur',commit)});
  // Block context menu
  el.addEventListener('contextmenu',e=>{e.preventDefault();if(!selection.has(el)){clearSel();selection.add(el);el.classList.add('sel')}openBlockCtx(e.clientX,e.clientY)});
}

/* ===== Context menus ===== */
const canvasCtx=document.getElementById('canvasCtx');const blockCtx=document.getElementById('blockCtx');
function openMenuAt(menu,sx,sy){menu.style.display='block';const r=stage.getBoundingClientRect();menu.style.left=(sx-r.left+6)+'px';menu.style.top=(sy-r.top+6)+'px'}
function closeMenus(){canvasCtx.style.display='none';blockCtx.style.display='none'}
stage.addEventListener('pointerdown',e=>{if(!canvasCtx.contains(e.target)&&!blockCtx.contains(e.target))closeMenus()});
stage.addEventListener('contextmenu',e=>{e.preventDefault();if(e.target.closest('.room'))return;openMenuAt(canvasCtx,e.clientX,e.clientY)});
function openBlockCtx(sx,sy){openMenuAt(blockCtx,sx,sy)}

canvasCtx.addEventListener('click',e=>{
  const act=e.target.closest('button')?.dataset?.act;if(!act)return;
  if(act==='grid'){gridEnabled=!gridEnabled;stage.classList.toggle('gridOn',gridEnabled)}
  if(act==='dup'){const ns=new Set();selection.forEach(n=>{const c=n.cloneNode(true);levels[currentLevel].layer.appendChild(c);attachRoom(c);c.style.left=(parseFloat(n.style.left)+GRID)+'px';c.style.top=(parseFloat(n.style.top)+GRID)+'px';ns.add(c)});clearSel();ns.forEach(n=>{n.classList.add('sel');selection.add(n)})}
  if(act==='del'){selection.forEach(n=>n.remove());selection.clear()}
  if(act==='exp-png')exportPNG();
  if(act==='exp-svg')exportSVG();
  if(act==='exp-dxf')exportDXF();
  closeMenus();
});
blockCtx.addEventListener('click',e=>{
  const act=e.target.closest('button')?.dataset?.act;if(!act)return;
  if(act==='dup'){selection.forEach(n=>{const c=n.cloneNode(true);levels[currentLevel].layer.appendChild(c);attachRoom(c);c.style.left=(parseFloat(n.style.left)+GRID)+'px';c.style.top=(parseFloat(n.style.top)+GRID)+'px'})}
  if(act==='color'){selection.forEach(n=>{const i=COLORS.indexOf(n.style.background);n.style.background=COLORS[(i+1)%COLORS.length]||COLORS[0]})}
  if(act==='del'){selection.forEach(n=>n.remove());selection.clear()}
  closeMenus();
});

/* ===== Exporters (PNG, SVG, DXF) ===== */
function nodesBBox(nodes){const xs=nodes.map(n=>parseFloat(n.style.left)),ys=nodes.map(n=>parseFloat(n.style.top)),rs=nodes.map(n=>parseFloat(n.style.left)+n.clientWidth),bs=nodes.map(n=>parseFloat(n.style.top)+n.clientHeight);return{l:Math.min(...xs),t:Math.min(...ys),r:Math.max(...rs),b:Math.max(...bs)}}
function exportPNG(){const nodes=getCurrentRooms();if(!nodes.length)return alert('Nothing to export.');const bb=nodesBBox(nodes),pad=40,w=Math.ceil(bb.r-bb.l+pad*2),h=Math.ceil(bb.b-bb.t+pad*2);const c=document.createElement('canvas');c.width=w;c.height=h;const x=c.getContext('2d');x.fillStyle='#0b0f15';x.fillRect(0,0,w,h);if(gridEnabled){x.strokeStyle='#1d2533';x.lineWidth=1;for(let i=pad;i<w-pad;i+=GRID){x.beginPath();x.moveTo(i,0);x.lineTo(i,h);x.stroke()}for(let j=pad;j<h-pad;j+=GRID){x.beginPath();x.moveTo(0,j);x.lineTo(w,j);x.stroke()}}nodes.forEach(n=>{const xx=parseFloat(n.style.left)-bb.l+pad,yy=parseFloat(n.style.top)-bb.t+pad,ww=n.clientWidth,hh=n.clientHeight;x.fillStyle=n.style.background;x.fillRect(xx,yy,ww,hh);x.fillStyle='#0c1016';x.font='12px Inter,Arial';x.fillText(n.querySelector('.label').textContent,xx+8,yy+16);x.fillText(n.querySelector('.area').textContent,xx+8,yy+hh-10)});c.toBlob(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='plan.png';a.click();URL.revokeObjectURL(a.href)})}
function exportSVG(){const nodes=getCurrentRooms();if(!nodes.length)return alert('Nothing to export.');const bb=nodesBBox(nodes),pad=40,w=Math.ceil(bb.r-bb.l+pad*2),h=Math.ceil(bb.b-bb.t+pad*2),esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;');let s=`<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">\n<rect x="0" y="0" width="${w}" height="${h}" fill="#0b0f15"/>`;if(gridEnabled){for(let i=pad;i<w-pad;i+=GRID)s+=`<line x1="${i}" y1="0" x2="${i}" y2="${h}" stroke="#1d2533" stroke-width="1"/>`;for(let j=pad;j<h-pad;j+=GRID)s+=`<line x1="0" y1="${j}" x2="${w}" y2="${j}" stroke="#1d2533" stroke-width="1"/>`}nodes.forEach(n=>{const xx=parseFloat(n.style.left)-bb.l+pad,yy=parseFloat(n.style.top)-bb.t+pad,ww=n.clientWidth,hh=n.clientHeight,fill=n.style.background||'#888',name=esc(n.querySelector('.label').textContent),area=esc(n.querySelector('.area').textContent);s+=`<rect x="${xx}" y="${yy}" width="${ww}" height="${hh}" fill="${fill}"/>`;s+=`<text x="${xx+8}" y="${yy+16}" font-family="Inter,Arial" font-size="12" fill="#0c1016">${name}</text>`;s+=`<text x="${xx+8}" y="${yy+hh-10}" font-family="Inter,Arial" font-size="12" fill="#0c1016">${area}</text>`});s+='</svg>';const b=new Blob([s],{type:'image/svg+xml'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='plan.svg';a.click();URL.revokeObjectURL(a.href)}
function exportDXF(){const nodes=getCurrentRooms();if(!nodes.length)return alert('Nothing to export.');const bb=nodesBBox(nodes);const rect=(x,y,w,h,L)=>`0
LWPOLYLINE
8
${L}
90
4
70
1
10
${x}
20
${-y}
10
${x+w}
20
${-y}
10
${x+w}
20
${-(y+h)}
10
${x}
20
${-(y+h)}
`;const text=(x,y,txt,L,h=2.5)=>`0
TEXT
8
${L}
10
${x}
20
${-y}
40
${h}
1
${txt}
`;let d=`0
SECTION
2
HEADER
0
ENDSEC
0
SECTION
2
ENTITIES
`;nodes.forEach(n=>{const xx=parseFloat(n.style.left)-bb.l,yy=parseFloat(n.style.top)-bb.t,w=n.clientWidth,h=n.clientHeight,name=n.querySelector('.label').textContent.replace(/\n/g,' '),area=n.querySelector('.area').textContent.replace(/\n/g,' ');d+=rect(xx,yy,w,h,'ROOM');d+=text(xx+4,yy+6,name,'TEXT',3);d+=text(xx+4,yy+h-6,area,'TEXT',3)});d+=`0
ENDSEC
0
EOF`;const b=new Blob([d],{type:'application/dxf'}),a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='plan.dxf';a.click();URL.revokeObjectURL(a.href)}

/* ===== Toolbar / FAB ===== */
document.getElementById('toggleIso').addEventListener('click',()=>{wrap.classList.toggle('isometric');document.getElementById('toggleIso').textContent=wrap.classList.contains('isometric')?'3D':'2D'});
const exportBtn=document.getElementById('exportBtn'),exportMenu=document.getElementById('exportMenu');
exportBtn.addEventListener('click',()=>{exportMenu.style.display=exportMenu.style.display==='block'?'none':'block'});
document.addEventListener('pointerdown',e=>{if(!exportMenu.contains(e.target)&&e.target!==exportBtn)exportMenu.style.display='none'});
exportMenu.addEventListener('click',e=>{const t=e.target.closest('button')?.dataset?.x;if(!t)return;if(t==='png')exportPNG();if(t==='svg')exportSVG();if(t==='dxf')exportDXF();exportMenu.style.display='none'});

/* FAB + Add-room Sheet */
const fab=document.getElementById('fab'),sheet=document.getElementById('sheet'),nameIn=document.getElementById('nameIn'),areaIn=document.getElementById('areaIn'),swWrap=document.getElementById('swatches'),addBtn=document.getElementById('addBtn'),cancelBtn=document.getElementById('cancelBtn');
let chosenColor=COLORS[1];function selectSwatch(n){[...swWrap.children].forEach(c=>c.dataset.sel='0');n.dataset.sel='1'}
COLORS.forEach(c=>{const d=document.createElement('div');d.className='sw';d.style.background=c;d.title=c;d.addEventListener('click',()=>{selectSwatch(d);chosenColor=c});swWrap.appendChild(d)});selectSwatch(swWrap.children[1]);
function openSheet(){sheet.style.display='block';nameIn.value='';areaIn.value=60;chosenColor=COLORS[1];selectSwatch(swWrap.children[1])}
function closeSheet(){sheet.style.display='none'}
fab.addEventListener('click',openSheet);
cancelBtn.addEventListener('click',closeSheet);
addBtn.addEventListener('click',()=>{const rect=stage.getBoundingClientRect(),cx=(rect.width/2-offset.x)/scale,cy=(rect.height/2-offset.y)/scale;createRoom({name:nameIn.value.trim()||'Room',m2:Math.max(1,parseFloat(areaIn.value)||60),color:chosenColor,x:cx-80,y:cy-60});closeSheet()});

/* Floors */
document.getElementById('addLevel').addEventListener('click',()=>{const idx=addLevel();setLevel(idx)});
document.getElementById('dupLevel').addEventListener('click',()=>duplicateLevel(currentLevel));
document.getElementById('delLevel').addEventListener('click',()=>removeLevel(currentLevel));

/* Demo */
createRoom({name:'Childcare 1',m2:70,color:COLORS[0],x:0,y:0});
createRoom({name:'Kinder 1',m2:110,color:COLORS[1],x:240,y:0});
</script>
</body>
</html>
